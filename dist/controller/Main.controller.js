sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,t){const o="add";const i="edit";return e.extend("benlem.zfirebase.controller.Main",{onInit:function(){const e=this.getView().getModel("firebase").getData().firestore;this.collRefEmployees=e.collection("employees");var t={employees:[]};var o=new sap.ui.model.json.JSONModel(t);this.getView().setModel(o);this.getRealTimeEmployees()},getEmployees:function(){this.collRefEmployees.get().then(e=>{var t=this.getView().getModel();var o=t.getData();var i=e.docs.map(e=>{return e.data()});o.employees=i;this.getView().byId("employeesTable").getBinding("items").refresh()},e=>{this._displayError(e.message)})},getRealTimeEmployees:function(){this.collRefEmployees.onSnapshot(e=>{var t=this.getView().getModel();var o=t.getData();e.docChanges().forEach(e=>{var t=e.doc.data();t.id=e.doc.id;switch(e.type){case"added":o.employees.push(t);break;case"modified":let i=o.employees.map(e=>{return e.id}).indexOf(t.id);o.employees[i]=t;break;case"removed":let a=o.employees.map(e=>{return e.id}).indexOf(t.id);o.employees.splice(a,1);break;default:break}});this.getView().getModel().refresh(true);this.getView().byId("employeesTable").getBinding("items").refresh()},e=>{this._displayError(e.message)})},onDelete:function(e){var t=this.getView().getModel();var o=e.getSource().getParent().getParent().getBindingContextPath();var i=t.getObject(o).id;this.collRefEmployees.doc(i).delete().then(e=>{t.refresh()},e=>{this._displayError(e.message)})},onPressItem:function(e){var t=e.getParameter("listItem").getBindingContextPath();this._getEmployeeDetail(t);if(!this._oDetailsPopover){this._oDetailsPopover=sap.ui.xmlfragment("employeeDetailsFragment","benlem.zfirebase.view.fragment.empDetails",this);this.getView().addDependent(this._oDetailsPopover);sap.ui.core.Fragment.byId("employeeDetailsFragment","detailsPopover").bindElement({path:"/",model:"detailsModel"})}this._oDetailsPopover.openBy(e.getParameter("listItem"))},onOpenDialog:function(e){var t=e.getSource().getId();if(t.includes("addButton")){this._cleanFormModel()}else if(t.includes("editButton")){var o=e.getSource().getParent().getBindingContext().getPath();this._bindEmployeeFormModel(o)}if(!this._oFormDialog){this._oFormDialog=sap.ui.xmlfragment("formFragment","benlem.zfirebase.view.fragment.dialog",this);this.getView().addDependent(this._oFormDialog);sap.ui.core.Fragment.byId("formFragment","addSimpleForm").bindElement({path:"/",model:"formModel"})}this._oFormDialog.open()},onCancel:function(){this._oFormDialog.close()},onSubmit:function(){var e=this.getOwnerComponent().getModel("formModel").getData();e.gender=sap.ui.core.Fragment.byId("formFragment","maleGenderRadio").getSelected()?"M":"F";switch(e.mode){case o:this._addEmployee(e);break;case i:this._updateEmployee(e);break;default:break}},_addEmployee:function(e){this.collRefEmployees.add({first_name:e.first_name,last_name:e.last_name,email:e.email,gender:e.gender}).then(e=>{this._oFormDialog.close()},e=>{this._displayError(e.message)})},_updateEmployee:function(e){this.collRefEmployees.doc(e.id).update({first_name:e.first_name,last_name:e.last_name,email:e.email,gender:e.gender}).then(e=>{this._oFormDialog.close()},e=>{this._displayError(e.message)})},_cleanFormModel:function(){var e=this.getOwnerComponent().getModel("formModel");var t={first_name:"",last_name:"",email:"",gender:"M",mode:o};e.setData(t)},_getEmployeeDetail:function(e){var t=this.getView().getModel().getObject(e);var o=this.getOwnerComponent().getModel("detailsModel");o.setData({});this.collRefEmployees.doc(t.id).get().then(e=>{if(e.exists)o.setData(e.data());else this._displayError("Employee does not exist")},e=>{this._displayError(e.message)})},_bindEmployeeFormModel:function(e){var t=this.getView().getModel().getObject(e);t.mode=i;this.getOwnerComponent().getModel("formModel").setData(t)},_displayError:function(e){return t.show(e,{title:"Error",icon:t.Icon.ERROR})}})});